<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Happy 23rd Birthday Sia! 🎂</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Pacifico&family=Great+Vibes&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 72 72%22><text y=%22.9em%22 font-size=%2260%22>🎂</text></svg>"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #1a1a1a;
        color: #eaeaea;
        overflow-x: hidden;
        overflow-y: hidden;
        min-height: 100vh;
        cursor: url("./img/birthday-cake.png") 8 8, auto;
      }

      /* Preloader */
      .preloader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        transition: opacity 0.8s, visibility 0.8s;
      }

      .preloader.loaded {
        opacity: 0;
        visibility: hidden;
      }

      .preloader-content {
        text-align: center;
      }

      .preloader h2 {
        font-family: "Great Vibes", cursive;
        font-size: 3.5rem;
        color: #ff4da6;
        margin-bottom: 30px;
        animation: pulse 1.5s ease-in-out infinite;
      }

      .loading-bar {
        width: 300px;
        height: 8px;
        background: rgba(255, 77, 166, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin: 20px auto;
      }

      .loading-progress {
        height: 100%;
        background: linear-gradient(90deg, #ff4da6, #ffd54f, #00e5ff);
        border-radius: 10px;
        width: 0%;
        transition: width 0.3s ease;
        animation: shimmer 2s ease-in-out infinite;
      }

      @keyframes shimmer {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .loading-text {
        color: #00e5ff;
        font-size: 1.2rem;
        margin-top: 15px;
      }

      /* Card Section */
      .card-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.8s, visibility 0.8s;
        opacity: 0;
        visibility: hidden;
      }

      .card-overlay.visible {
        opacity: 1;
        visibility: visible;
      }

      .card-overlay.hidden {
        opacity: 0;
        visibility: hidden;
      }

      .birthday-card {
        width: 420px;
        height: 550px;
        position: relative;
        transform-style: preserve-3d;
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
        transition: transform 0.8s;
      }

      .birthday-card.opened {
        transform: rotateY(-180deg);
      }

      .card-front,
      .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 20px;
        box-shadow: 0 25px 70px rgba(255, 77, 166, 0.3);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 50px;
        border: 2px solid rgba(255, 77, 166, 0.3);
      }

      .card-front {
        background: linear-gradient(135deg, #ff4da6 0%, #ffd54f 100%);
      }

      .card-back {
        background: linear-gradient(135deg, #00e5ff 0%, #ff4da6 100%);
        transform: rotateY(180deg);
      }

      .envelope-icon {
        font-size: 100px;
        margin-bottom: 30px;
        animation: bounce 2s ease-in-out infinite;
        filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3));
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-25px);
        }
      }

      .card-front h1 {
        font-family: "Great Vibes", cursive;
        font-size: 52px;
        color: #1a1a1a;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }

      .card-front p {
        font-size: 22px;
        color: #1a1a1a;
        text-align: center;
        font-weight: 300;
      }

      .card-back h2 {
        font-family: "Great Vibes", cursive;
        font-size: 48px;
        color: #ffffff;
        text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);
        margin-bottom: 30px;
        text-align: center;
      }

      .card-back p {
        color: #ffffff;
        font-size: 20px;
        text-align: center;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .open-btn {
        padding: 18px 50px;
        font-size: 20px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        background: #ffd54f;
        color: #1a1a1a;
        border: none;
        border-radius: 50px;
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
        box-shadow: 0 8px 20px rgba(255, 213, 79, 0.4);
        transition: all 0.3s;
      }

      .open-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 12px 30px rgba(255, 213, 79, 0.6);
      }

      /* Main Timeline Container */
      .timeline-container {
        display: none;
        min-height: 100vh;
        position: relative;
        visibility: hidden;
      }

      .timeline-container.active {
        display: block;
      }

      .timeline-container > div {
        position: absolute;
        left: 0;
        right: 0;
        top: 20vh;
        text-align: center;
      }

      /* Timeline Sections */
      .section-one {
        font-size: 4.5rem;
        font-family: "Great Vibes", cursive;
        color: #ff4da6;
      }

      .section-one span {
        color: #ffd54f;
      }

      .section-two {
        font-size: 1.5rem;
        font-weight: 300;
        color: #00e5ff;
        padding-top: 20rem;
      }

      .section-three {
        font-size: 3.5rem;
        font-weight: 600;
        color: #ff4da6;
      }

      .section-four .text-box {
        border: 3px solid #ff4da6;
        border-radius: 15px;
        margin: 0 auto;
        padding: 30px 30px 70px 30px;
        position: relative;
        width: 700px;
        max-width: 90%;
        background: rgba(26, 26, 26, 0.8);
        backdrop-filter: blur(10px);
      }

      .text-box p {
        margin: 0;
        text-align: left;
        color: #eaeaea;
        line-height: 1.8;
        font-size: 18px;
      }

      .text-box span {
        visibility: hidden;
      }

      .text-box .fake-btn {
        background: linear-gradient(135deg, #00e5ff 0%, #ff4da6 100%);
        border-radius: 8px;
        color: #1a1a1a;
        padding: 12px 30px;
        position: absolute;
        bottom: -80px;
        right: 20px;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(255, 77, 166, 0.4);
        transition: all 0.2s ease;
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
        display: inline-block;
        visibility: visible !important;
      }

      .section-five p {
        font-size: 2.2rem;
        position: absolute;
        left: 0;
        right: 0;
        color: #eaeaea;
      }

      .section-five .idea-3 strong {
        background: linear-gradient(135deg, #ff4da6 0%, #ffd54f 100%);
        border-radius: 8px;
        display: inline-block;
        padding: 5px 15px;
        color: #1a1a1a;
      }

      .section-five .idea-5 {
        font-size: 4.5rem;
        font-family: "Dancing Script", cursive;
        color: #ffd54f;
        text-shadow: 2px 2px 4px rgba(255, 77, 166, 0.3);
        letter-spacing: 1px;
      }

      .idea-5 span,
      .idea-6 span {
        display: inline-block;
      }

      .idea-6 span {
        font-size: 15rem;
        font-weight: bold;
        background: linear-gradient(
          135deg,
          #ff4da6 0%,
          #ffd54f 50%,
          #00e5ff 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Birthday Wish Section */
      .section-six {
        position: relative;
        top: 3vh;
      }

      .profile-picture {
        width: 350px;
        height: 350px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid #ff4da6;
        box-shadow: 0 15px 40px rgba(255, 77, 166, 0.5);
      }

      .hat {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: -15%;
        width: 100px;
        font-size: 80px;
      }

      .wish {
        margin-top: 15px;
      }

      .wish-hbd {
        font-size: 4.2rem;
        font-family: "Pacifico", cursive;
        margin: 20px 0;
        text-transform: none;
        color: #ff4da6;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
      }

      .wish-hbd span {
        display: inline-block;
      }

      .wish h5 {
        font-size: 1.8rem;
        font-weight: 300;
        margin: 20px 0;
        color: #00e5ff;
      }

      /* Enhanced Cake Section */
      .section-cake {
        position: absolute;
        left: 0;
        right: 0;
        top: 15vh;
        text-align: center;
      }

      .cake-title {
        font-family: "Great Vibes", cursive;
        font-size: 3.5rem;
        color: #ffd54f;
        margin-bottom: 40px;
        text-shadow: 0 5px 15px rgba(255, 213, 79, 0.5);
      }

      .cake-wrapper {
        position: relative;
        display: inline-block;
        margin-top: 20px;
      }

      /* Realistic Cake Design */
      .realistic-cake {
        position: relative;
        width: 250px;
        height: 200px;
        margin: 0 auto;
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
      }

      .plate {
        width: 270px;
        height: 110px;
        position: absolute;
        bottom: -10px;
        left: -10px;
        background-color: #ccc;
        border-radius: 50%;
        box-shadow: 0 2px 0 #b3b3b3, 0 4px 0 #b3b3b3,
          0 5px 40px rgba(0, 0, 0, 0.5);
      }

      .layer {
        position: absolute;
        display: block;
        width: 250px;
        height: 100px;
        border-radius: 50%;
        background-color: #553c13;
        box-shadow: 0 2px 0px #6a4b18, 0 4px 0px #33240b, 0 6px 0px #32230b,
          0 8px 0px #31230b, 0 10px 0px #30220b, 0 12px 0px #2f220b;
      }

      .layer-top {
        top: 0px;
      }
      .layer-middle {
        top: 33px;
      }
      .layer-bottom {
        top: 66px;
      }

      .icing {
        top: 2px;
        left: 5px;
        background-color: #f0e4d0;
        width: 240px;
        height: 90px;
        border-radius: 50%;
        position: absolute;
      }

      .icing:before {
        content: "";
        position: absolute;
        top: 4px;
        right: 5px;
        bottom: 6px;
        left: 5px;
        background-color: #f4ebdc;
        box-shadow: 0 0 4px #f6efe3;
        border-radius: 50%;
        z-index: 1;
      }

      .drip {
        display: block;
        width: 50px;
        height: 60px;
        border-bottom-left-radius: 25px;
        border-bottom-right-radius: 25px;
        background-color: #f0e4d0;
        position: absolute;
      }

      .drip1 {
        top: 53px;
        left: 5px;
        transform: skewY(15deg);
        height: 48px;
        width: 40px;
      }

      .drip2 {
        top: 69px;
        left: 181px;
        transform: skewY(-15deg);
      }

      .drip3 {
        top: 54px;
        left: 90px;
        width: 80px;
        border-bottom-left-radius: 40px;
        border-bottom-right-radius: 40px;
      }

      .candle {
        background-color: #7b020b;
        width: 12px;
        height: 35px;
        border-radius: 6px/3px;
        position: absolute;
        z-index: 10;
      }

      .candle:before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 12px;
        height: 6px;
        border-radius: 50%;
        background-color: #ad030f;
      }

      .candle.out .flame {
        display: none;
      }

      .flame {
        position: absolute;
        background-color: orange;
        width: 10px;
        height: 25px;
        border-radius: 8px 8px 8px 8px/20px 20px 8px 8px;
        top: -34px;
        left: 1px;
        z-index: 10;
        box-shadow: 0 0 10px rgba(255, 165, 0, 0.5),
          0 0 20px rgba(255, 165, 0, 0.5), 0 0 60px rgba(255, 165, 0, 0.5);
        transform-origin: 50% 90%;
        animation: flicker 1s ease-in-out alternate infinite;
      }

      @keyframes flicker {
        0% {
          transform: skewX(5deg);
          box-shadow: 0 0 10px rgba(255, 165, 0, 0.2),
            0 0 20px rgba(255, 165, 0, 0.2);
        }
        50% {
          transform: skewX(-5deg);
          box-shadow: 0 0 10px rgba(255, 165, 0, 0.5),
            0 0 20px rgba(255, 165, 0, 0.5);
        }
        100% {
          transform: skewX(5deg);
          box-shadow: 0 0 10px rgba(255, 165, 0, 0.5),
            0 0 20px rgba(255, 165, 0, 0.5);
        }
      }

      .blow-instruction {
        margin-top: 50px;
        font-size: 1.8rem;
        color: #00e5ff;
        font-family: "Poppins", sans-serif;
        animation: pulse 2s infinite;
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(0.95);
        }
      }

      .blown-message {
        margin-top: 40px;
        font-size: 2.5rem;
        color: #ffd54f;
        font-family: "Great Vibes", cursive;
        display: none;
      }

      .blown-message.show {
        display: block;
        animation: fadeInScale 1s;
      }

      @keyframes fadeInScale {
        0% {
          opacity: 0;
          transform: scale(0.5);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Final Section */
      .section-nine {
        opacity: 0;
      }

      .section-nine p {
        font-size: 2rem;
        font-weight: 300;
        color: #eaeaea;
      }

      #replay {
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
        color: #00e5ff;
        text-decoration: none;
        transition: all 0.3s;
      }

      #replay:hover {
        color: #ff4da6;
        transform: scale(1.05);
      }

      .last-smile {
        font-size: 3rem;
        color: #ffd54f;
      }

      /* Balloons */
      .balloon {
        position: fixed;
        bottom: -150px;
        font-size: 60px;
        animation: float-up 10s ease-in infinite;
        z-index: 100;
        filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3));
      }

      @keyframes float-up {
        0% {
          bottom: -150px;
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        100% {
          bottom: 110vh;
          opacity: 0;
        }
      }

      /* Fireworks */
      .firework {
        position: fixed;
        width: 5px;
        height: 5px;
        border-radius: 50%;
        z-index: 50;
      }

      /* Confetti */
      .confetti {
        position: fixed;
        width: 12px;
        height: 12px;
        z-index: 50;
        animation: confetti-fall 4s linear infinite;
      }

      @keyframes confetti-fall {
        0% {
          top: -20px;
          opacity: 1;
          transform: rotate(0deg);
        }
        100% {
          top: 110vh;
          opacity: 0.5;
          transform: rotate(720deg);
        }
      }

      /* Music Control */
      .music-control {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #ff4da6 0%, #ffd54f 100%);
        border-radius: 50%;
        width: 70px;
        height: 70px;
        display: none;
        justify-content: center;
        align-items: center;
        cursor: url("./img/birthday-candle.png") 6 2, pointer;
        box-shadow: 0 8px 25px rgba(255, 77, 166, 0.5);
        z-index: 9999;
        transition: all 0.3s;
      }

      .music-control:hover {
        transform: scale(1.1) rotate(10deg);
        box-shadow: 0 12px 35px rgba(255, 77, 166, 0.7);
      }

      .music-control span {
        font-size: 32px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .birthday-card {
          width: 340px;
          height: 480px;
          padding: 30px;
        }
        .section-one {
          font-size: 3rem;
        }
        .section-three {
          font-size: 2.5rem;
        }
        .section-four .text-box {
          width: 90%;
          padding: 20px 20px 60px 20px;
        }
        .idea-6 span {
          font-size: 10rem;
        }
        .profile-picture {
          width: 250px;
          height: 250px;
        }
        .realistic-cake {
          transform: scale(0.8);
        }
        .wish-hbd {
          font-size: 3rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Preloader -->
    <div class="preloader" id="preloader">
      <div class="preloader-content">
        <h2>Preparing Something Special...</h2>
        <div class="loading-bar">
          <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <p class="loading-text" id="loadingText">Loading... 0%</p>
      </div>
    </div>

    <!-- Card Overlay -->
    <div class="card-overlay" id="cardOverlay">
      <div class="birthday-card" id="birthdayCard">
        <div class="card-front">
          <div class="envelope-icon">💌</div>
          <h1>For My Love</h1>
          <p>Click to open your surprise...</p>
        </div>
        <div class="card-back">
          <h2>Happy 23rd Birthday! <br />🎉🎉🎉</h2>
          <p>
            Hey, Hunny I've created something special for you...<br />
            I hope you like it! ✨
          </p>
          <button class="open-btn" id="openBtn">Start! 🎈</button>
        </div>
      </div>
    </div>

    <!-- Main Timeline Container -->
    <div class="timeline-container" id="timelineContainer">
      <div class="section-one">
        <h1>Hi <span>Sia</span></h1>
      </div>

      <div class="section-two">
        <p>I really miss you btw! ✨</p>
      </div>

      <div class="section-three">
        <p>It's your 23rd birthday!! :D 🎂</p>
      </div>

      <div class="section-four">
        <div class="text-box">
          <p class="hbd-chatbox">
            Happy birthday, my love! Twenty-three looks absolutely radiant on
            you. Every moment with you feels like magic, and I'm so grateful to
            celebrate this special day with you. You make every day brighter,
            every laugh louder, and every memory sweeter. Here's to you and all
            the incredible moments we'll create together! 💕
          </p>
          <p class="fake-btn">Send 💌</p>
        </div>
      </div>

      <div class="section-five">
        <p class="idea-1">That's what I was going to say.</p>
        <p class="idea-2">But then I realized...</p>
        <p class="idea-3">
          I needed to do something<br />
          <strong>extraordinary</strong>
        </p>
        <p class="idea-4">Because...</p>
        <p class="idea-5">You Are Extraordinary ✨</p>
        <p class="idea-6">
          <span>2</span>
          <span>3</span>
        </p>
      </div>

      <div class="section-six">
        <div class="hat">
          <img src="./img/hat.svg" alt="birthday hat" />
        </div>
        <img
          src="./img/sia.jpg"
          alt="Sia"
          class="profile-picture"
          id="profilePic"
        />
        <div class="wish">
          <h3 class="wish-hbd">Happy Birthday Sia!</h3>
          <h5>
            May this year bring you endless joy and beautiful memories! 🌟
          </h5>
        </div>
      </div>

      <div class="section-cake">
        <h2 class="cake-title">Now... Make Your Wish! 🌟</h2>
        <div class="cake-wrapper">
          <div class="realistic-cake" id="cake">
            <div class="plate"></div>
            <div class="layer layer-bottom"></div>
            <div class="layer layer-middle"></div>
            <div class="layer layer-top"></div>
            <div class="icing"></div>
            <div class="drip drip1"></div>
            <div class="drip drip2"></div>
            <div class="drip drip3"></div>
          </div>
        </div>
        <p class="blow-instruction" id="blowInstruction">
          🌬️ Blow into your mic to blow out the candles! 🌬️
        </p>
        <p class="blown-message" id="blownMessage">
          🎊 Your wish has been sent to the stars! 🎊<br />
          May all your dreams come true! ✨
        </p>
      </div>

      <div class="section-nine">
        <p>So... did you love it? 💕</p>
        <p id="replay">Click here to experience it all over again! 🔄</p>
        <p class="last-smile">Forever yours! 💖</p>
      </div>
    </div>

    <!-- Music Control -->
    <div class="music-control" id="musicControl">
      <span id="musicIcon">🔊</span>
    </div>

    <!-- Hidden Audio -->
    <audio id="bgMusic" loop="false">
      <source src="./music/hbd.mpeg" type="audio/mpeg" />
    </audio>

    <!-- GSAP Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>

    <script>
      // Asset Preloader
      let loadedAssets = 0;
      const totalAssets = 2; // 1 image + 1 audio

      function updateProgress() {
        loadedAssets++;
        const progress = (loadedAssets / totalAssets) * 100;
        document.getElementById("loadingProgress").style.width = progress + "%";
        document.getElementById(
          "loadingText"
        ).textContent = `Loading... ${Math.round(progress)}%`;

        if (loadedAssets === totalAssets) {
          setTimeout(() => {
            document.getElementById("preloader").classList.add("loaded");
            document.getElementById("cardOverlay").classList.add("visible");
          }, 500);
        }
      }

      // Preload image
      const img = new Image();
      img.onload = updateProgress;
      img.onerror = updateProgress;
      img.src = "./img/sia.jpg";

      // Preload audio
      const audio = document.getElementById("bgMusic");
      audio.addEventListener("canplaythrough", updateProgress, { once: true });
      audio.addEventListener("error", updateProgress, { once: true });
      audio.load();

      // Main variables
      const card = document.getElementById("birthdayCard");
      const cardOverlay = document.getElementById("cardOverlay");
      const openBtn = document.getElementById("openBtn");
      const timelineContainer = document.getElementById("timelineContainer");
      const musicControl = document.getElementById("musicControl");
      const musicIcon = document.getElementById("musicIcon");
      const bgMusic = audio;
      const blowInstruction = document.getElementById("blowInstruction");
      const blownMessage = document.getElementById("blownMessage");
      const cakeElement = document.getElementById("cake");

      let musicPlaying = false;
      let candlesBlown = false;
      let candles = [];
      let audioContext, analyser, microphone;

      // Card flip animation
      card.addEventListener("click", function () {
        if (!card.classList.contains("opened")) {
          card.classList.add("opened");
        }
      });

      // Open button - start the experience
      openBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        cardOverlay.classList.add("hidden");

        setTimeout(() => {
          timelineContainer.classList.add("active");
          musicControl.style.display = "flex";

          // Reset and play music
          bgMusic.currentTime = 0;
          bgMusic
            .play()
            .then(() => {
              musicPlaying = true;
              musicIcon.textContent = "🔊";
            })
            .catch(() => {
              console.log("Music autoplay prevented");
            });

          startBalloons();
          startConfetti();
          startFireworks();
          animationTimeline();
        }, 800);
      });

      // Music control
      musicControl.addEventListener("click", function () {
        if (musicPlaying) {
          bgMusic.pause();
          musicIcon.textContent = "🔇";
          musicPlaying = false;
        } else {
          bgMusic.play();
          musicIcon.textContent = "🔊";
          musicPlaying = true;
        }
      });

      // Create candles on cake
      function createCandles() {
        const positions = [
          { left: 80, top: -20 },
          { left: 125, top: -20 },
          { left: 170, top: -20 },
        ];

        positions.forEach((pos) => {
          const candle = document.createElement("div");
          candle.className = "candle";
          candle.style.left = pos.left + "px";
          candle.style.top = pos.top + "px";

          const flame = document.createElement("div");
          flame.className = "flame";
          candle.appendChild(flame);

          cakeElement.appendChild(candle);
          candles.push(candle);
        });
      }

      // Main GSAP Animation Timeline
      function animationTimeline() {
        const textBoxChars = document.querySelector(".hbd-chatbox");
        const hbd = document.querySelector(".wish-hbd");

        if (textBoxChars) {
          textBoxChars.innerHTML = `<span>${textBoxChars.innerHTML
            .split("")
            .join("</span><span>")}</span>`;
        }

        if (hbd) {
          hbd.innerHTML = `<span>${hbd.innerHTML
            .split("")
            .join("</span><span>")}</span>`;
        }

        const ideaTextTrans = {
          opacity: 0,
          y: -20,
          rotationX: 5,
          skewX: "15deg",
        };

        const ideaTextTransLeave = {
          opacity: 0,
          y: 20,
          rotationY: 5,
          skewX: "-15deg",
        };

        tl = gsap.timeline();

        tl.to(".timeline-container", 0.6, { visibility: "visible" })
          .from(".section-one", 0.7, { opacity: 0, y: 10 })
          .from(".section-two", 0.4, { opacity: 0, y: 10 })
          .to(".section-one", 0.7, { opacity: 0, y: 10 }, "+=3")
          .to(".section-two", 0.7, { opacity: 0, y: 10 }, "-=1")
          .from(".section-three", 0.7, { opacity: 0, y: 10 })
          .to(".section-three", 0.7, { opacity: 0, y: 10 }, "+=2.5")
          .from(".section-four", 0.7, { scale: 0.2, opacity: 0 })
          .from(".fake-btn", 0.3, { scale: 1, opacity: 1 })
          .staggerTo(".hbd-chatbox span", 1.5, { visibility: "visible" }, 0.05)
          .to(
            ".fake-btn",
            0.1,
            {
              background: "linear-gradient(135deg, #FFD54F 0%, #FF4DA6 100%)",
              scale: 0.95,
              y: 2,
              boxShadow: "0 2px 5px rgba(255, 77, 166, 0.4)",
              ease: "power2.inOut",
            },
            "+=3.5"
          )
          .to(
            ".fake-btn",
            0.2,
            {
              scale: 1,
              y: 0,
              boxShadow: "0 5px 15px rgba(255, 77, 166, 0.4)",
              ease: "back.out(1.7)",
            },
            "+=0.1"
          )
          .to(".section-four", 0.5, { scale: 0.2, opacity: 0, y: -150 }, "+=1")
          .from(".idea-1", 0.7, ideaTextTrans)
          .to(".idea-1", 0.7, ideaTextTransLeave, "+=2")
          .from(".idea-2", 0.7, ideaTextTrans)
          .to(".idea-2", 0.7, ideaTextTransLeave, "+=2")
          .from(".idea-3", 0.7, ideaTextTrans)
          .to(".idea-3 strong", 0.5, {
            scale: 1.2,
            x: 10,
            boxShadow: "0 10px 30px rgba(255, 77, 166, 0.5)",
          })
          .to(".idea-3", 0.7, ideaTextTransLeave, "+=2")
          .from(".idea-4", 0.7, ideaTextTrans)
          .to(".idea-4", 0.7, ideaTextTransLeave, "+=2")
          .from(
            ".idea-5",
            0.7,
            {
              rotationX: 15,
              rotationZ: -10,
              skewY: "-5deg",
              y: 50,
              z: 10,
              opacity: 0,
            },
            "+=1"
          )
          .to(".idea-5", 0.7, { scale: 0.2, opacity: 0 }, "+=2")
          .staggerFrom(
            ".idea-6 span",
            0.8,
            {
              scale: 3,
              opacity: 0,
              rotation: 15,
            },
            0.2
          )
          .staggerTo(
            ".idea-6 span",
            0.8,
            {
              scale: 3,
              opacity: 0,
              rotation: -15,
            },
            0.2,
            "+=1.5"
          )
          .from(".section-six .profile-picture", 0.5, {
            scale: 3.5,
            opacity: 0,
            x: 25,
            y: -25,
            rotationZ: -45,
          })
          .from(".hat", 0.5, {
            x: -100,
            y: 350,
            rotation: -180,
            opacity: 0,
          })
          .staggerFrom(
            ".wish-hbd span",
            0.7,
            {
              opacity: 0,
              y: -50,
              rotation: 150,
              skewX: "30deg",
            },
            0.1
          )
          .staggerFromTo(
            ".wish-hbd span",
            0.7,
            {
              scale: 1.4,
              rotationY: 150,
            },
            {
              scale: 1,
              rotationY: 0,
              color: "#FF4DA6",
            },
            0.1,
            "party"
          )
          .from(
            ".wish h5",
            0.5,
            {
              opacity: 0,
              y: 10,
              skewX: "-15deg",
            },
            "party"
          )
          .to(".section-six", 0.5, { opacity: 0, y: 30 }, "+=2")
          .from(".section-cake", 0.7, { opacity: 0, scale: 0.5 })
          .add(() => {
            createCandles();
            startMicrophoneDetection();
          })
          .to(".section-cake", 0.5, { opacity: 0 }, "+=8")
          .to(".section-nine", 0.7, { opacity: 1 })
          .from(".section-nine p", 0.7, {
            opacity: 0,
            y: 20,
            scale: 0.5,
            stagger: { amount: 1, from: "start" },
            clearProps: "all",
          });

        document.getElementById("replay").addEventListener("click", () => {
          candlesBlown = false;
          candles.forEach((c) => c.classList.remove("out"));
          blowInstruction.style.display = "block";
          blownMessage.classList.remove("show");

          // Reset and play music again
          bgMusic.currentTime = 0;
          bgMusic
            .play()
            .then(() => {
              musicPlaying = true;
              musicIcon.textContent = "🔊";
            })
            .catch(() => {
              console.log("Music autoplay prevented");
            });

          tl.restart();
        });
      }

      // Microphone detection for blowing candles
      let micStream = null;
      let isListening = false;
      let tl = null; // Will store the timeline reference

      function stopMicrophoneDetection() {
        if (micStream) {
          micStream.getTracks().forEach((track) => track.stop());
          micStream = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        isListening = false;
      }

      // Check if we already have microphone permission
      async function checkMicrophonePermission() {
        try {
          const permissions = await navigator.permissions.query({
            name: "microphone",
          });
          return permissions.state === "granted";
        } catch (err) {
          return false;
        }
      }

      async function startMicrophoneDetection() {
        if (candlesBlown || isListening) return;

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          setupClickFallback();
          return;
        }

        const hasPermission = await checkMicrophonePermission();

        if (hasPermission) {
          // Already have permission - go straight to detection
          requestMicPermission();
        } else {
          // Need permission - pause everything and show instruction
          pauseExperience();
          showPermissionRequest();
        }
      }

      function pauseExperience() {
        // Pause timeline
        if (tl && !tl.paused()) {
          tl.pause();
        }
        // Pause music
        if (musicPlaying) {
          bgMusic.pause();
          musicIcon.textContent = "🔇";
        }
      }

      function resumeExperience() {
        // Resume timeline
        if (tl && tl.paused()) {
          tl.resume();
        }
        // Resume music
        if (musicPlaying) {
          bgMusic.play();
          musicIcon.textContent = "🔊";
        }
      }

      function showPermissionRequest() {
        blowInstruction.textContent = "🎤 Click here to enable microphone...";
        blowInstruction.style.animation = "pulse 2s infinite";
        blowInstruction.addEventListener("click", requestMicPermission, {
          once: true,
        });
      }

      function requestMicPermission() {
        blowInstruction.textContent = "🎤 Requesting microphone access...";

        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            micStream = stream;
            setupAudioAnalysis(stream);
            resumeExperience();
          })
          .catch((err) => {
            console.error("Microphone access denied:", err);
            setupClickFallback();
            resumeExperience();
          });
      }

      function setupClickFallback() {
        blowInstruction.textContent =
          "💡 Click the cake to blow out candles! 💡";
        blowInstruction.style.animation = "pulse 2s infinite";
        cakeElement.addEventListener("click", blowCandles, { once: true });
      }

      function setupAudioAnalysis(stream) {
        blowInstruction.textContent =
          "🌬️ Blow into your mic to blow out the candles! 🌬️";
        blowInstruction.style.animation = "pulse 2s infinite";

        try {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          microphone = audioContext.createMediaStreamSource(stream);

          analyser.smoothingTimeConstant = 0.8;
          analyser.fftSize = 512;
          microphone.connect(analyser);

          const dataArray = new Uint8Array(analyser.frequencyBinCount);
          isListening = true;

          function detectBlow() {
            if (!isListening || candlesBlown) {
              stopMicrophoneDetection();
              return;
            }

            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
              sum += dataArray[i];
            }
            const average = sum / dataArray.length;

            if (average > 35) {
              stopMicrophoneDetection();
              blowCandles();
              return;
            }

            requestAnimationFrame(detectBlow);
          }

          detectBlow();
        } catch (err) {
          console.error("Audio setup error:", err);
          stopMicrophoneDetection();
          setupClickFallback();
        }
      }

      function blowCandles() {
        if (candlesBlown) return;
        candlesBlown = true;

        stopMicrophoneDetection();

        candles.forEach((candle, index) => {
          setTimeout(() => {
            candle.classList.add("out");
          }, index * 200);
        });

        setTimeout(() => {
          blowInstruction.style.display = "none";
          blownMessage.classList.add("show");

          for (let i = 0; i < 6; i++) {
            setTimeout(() => {
              const x = Math.random() * window.innerWidth;
              const y = Math.random() * (window.innerHeight / 2);
              createFirework(x, y);
            }, i * 400);
          }
        }, 800);
      }

      // Balloons effect
      function startBalloons() {
        setInterval(() => {
          const balloon = document.createElement("div");
          balloon.className = "balloon";
          const balloons = ["🎈", "🎈", "🎈"];
          balloon.textContent =
            balloons[Math.floor(Math.random() * balloons.length)];
          balloon.style.left = Math.random() * 100 + "%";
          balloon.style.animationDuration = 12 + Math.random() * 8 + "s";
          balloon.style.animationDelay = Math.random() * 3 + "s";
          document.body.appendChild(balloon);
          setTimeout(() => balloon.remove(), 15000);
        }, 1200);
      }

      // Confetti effect
      function startConfetti() {
        const colors = ["#FF4DA6", "#FFD54F", "#00E5FF"];
        setInterval(() => {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.left = Math.random() * 100 + "%";
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDuration = 3 + Math.random() * 2 + "s";
          confetti.style.animationDelay = Math.random() + "s";
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 6000);
        }, 150);
      }

      // Fireworks effect
      function createFirework(x, y) {
        const colors = ["#FF4DA6", "#FFD54F", "#00E5FF"];
        for (let i = 0; i < 40; i++) {
          const firework = document.createElement("div");
          firework.className = "firework";
          firework.style.left = x + "px";
          firework.style.top = y + "px";
          firework.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];

          const angle = (Math.PI * 2 * i) / 40;
          const velocity = 2 + Math.random() * 3;
          document.body.appendChild(firework);

          let posX = x,
            posY = y;
          let velocityX = Math.cos(angle) * velocity;
          let velocityY = Math.sin(angle) * velocity;

          const animation = setInterval(() => {
            velocityY += 0.15;
            posX += velocityX;
            posY += velocityY;
            firework.style.left = posX + "px";
            firework.style.top = posY + "px";

            if (posY > window.innerHeight) {
              clearInterval(animation);
              firework.remove();
            }
          }, 16);
        }
      }

      function startFireworks() {
        setInterval(() => {
          const x = Math.random() * window.innerWidth;
          const y = Math.random() * (window.innerHeight / 2);
          createFirework(x, y);
        }, 2500);
      }
    </script>
  </body>
</html>
